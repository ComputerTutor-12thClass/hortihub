{% extends 'hortihome/base.html' %}
{% load widget_tweaks %}

{% block title %}{{ post.post_body }}{% endblock %}

{% block body %}
<div class="container">
	<div class="card">
		{% csrf_token %}
		{{ post.post_body }}
		{% if post.image %}
		<img src="{{  post.image.url }}"/>
		{% endif %}
		
		<div class="post-footer">
			<div class="row countline">
				<div class="col-md-6">
			<span class="text-center count">
				Likes: <span id="likes">{{ post.likes.count }}</span>
				</span>
				</div>
				<div class="col-md-6">
			<span class="text-center count">
				view{{ total_views|pluralize }}:
				<span>{{ total_views }}</span>
			</span>
				</div>
			</div>
			<a class="button" data-href="{{ post.get_absolute_url }}">
				<div>
					{% if request.user not in post.likes.all %}
					<button class=" btn btn-default fas fa-heart heart">Like</button>
					{% else %}
					<button class=" btn btn-default fas fa-heart heart">UnLike</button>
					{% endif %}
				</div>
			</a>
		</div>
	</div>
	<div class="card">
		<p>Comments</p>
		<!-- Comments Form LEAVE A COMMENT -->
		<form method="post" action="" enctype='multipart/form-data'>
			{% csrf_token %}
            {{ form_comment}}
            <input type='submit' value='Post comment' class='btn btn-default'>
        </form>
		
		{% for comment in post.comments %}
		<section>
			<blockquote>
				{{ comment.content }}
				<footer class="blockquote-footer">{{ comment.user }} | {{ comment.timestamp|timesince }} ago</footer>
				<div class='comment-reply'>
					{% for child_comment in comment.children %}
					<blockquote>
						<p>{{ child_comment.content }}</p>
						<footer class="blockquote-footer"> {{ child_comment.user }} | {{ child_comment.timestamp|timesince}} ago
						</footer>
					</blockquote>
					{% endfor %}
				</div>
				<form method="post" action="" enctype='multipart/form-data'>
					{% csrf_token %}
					{{ form_comment }}
					<input type='hidden' name='parent_id' value='{{ comment.pk }}'>
					<input type='submit' value='Reply' class='btn btn-default'>
				</form>
				<hr/>
			</blockquote>
		</section>
		{% endfor %}
	</div>
</div>

{% endblock %}

{% block domready %}
$(document).ready(function() {
  $("button").click(function(e) {
    e.preventDefault();
    var this_ = $(this)
    var likeUrl = this_.attr("data-href")
    var csrftoken = getCookie('csrftoken');

    $.ajax({
      headers: {
        "X-CSRFToken": csrftoken
      },
      url: likeUrl,
      method: "POST",
      data: {},
      success: function(result) {
        console.log('success');
        if (result.liked) {
          var likes = result["likes"]
          document.getElementById("likes").innerHTML = likes;
          this_.html("Unlike")
        } else {
          var likes = result["likes"]
          document.getElementById("likes").innerHTML = likes;
          this_.html("Like")
        }
      },
      error: function(result) {
        console.log('error');
      }
    });
  });
});

{% endblock %}